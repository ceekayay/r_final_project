---
title: "Feeder Watch Dashboard"
output: flexdashboard::flex_dashboard
runtime: shiny
---

```{r global, include=FALSE, warning = FALSE}
library("flexdashboard")
library("tidyverse")
library("readxl")
library("lubridate")
library("stringr")
library("ggplot2")
library("ggthemes")
library("tigris")
library("leaflet")
library("viridis")
library("shiny")
library("sf")
library("DT")

sightings_data <- read_csv("data/PFW_2021_public.csv") %>%
  mutate(date = as.Date(paste(Year, Month, Day, sep = "-")))

species_names <- read_excel("data/Species_Codes.xlsx") %>%
  rename_all(tolower)

test_df <- species_data %>%
  group_by(date, species_code, common_name) %>%
  summarize(total = sum(how_many))

pfw <- readr::read_csv("./big_data/PFW_all_2021_2024_May2024_Public.csv") %>% 
  mutate(date = as.Date(paste(Year, Month, Day, sep = "-"))) %>%
  left_join(species_names, by = "species_code") %>%
  mutate(common_name = primary_com_name)
```
Column
-----------------------------


```{r test_map}
leaflet_ui <- fluidPage(
  titlePanel("Bird Observations Map"),
  sidebarLayout(
    sidebarPanel(
      selectInput("year", "Observation Year:",
                  choices = 
                    sort(unique(pfw$Year)))
    ),
    mainPanel(
      leafletOutput("map")
    )
  )
)

server <- function(input, output, session) {
  
  filtered_data <- reactive({
    pfw %>%
      filter(Year == input$year)
  })
  
  output$map <- renderLeaflet({
    data <- filtered_data()
    
    unique_locations <- data %>%
      select(LATITUDE, LONGITUDE) %>%
      distinct()
    
state_species_count <- data %>%
  group_by(SUBNATIONAL1_CODE) %>%
  summarize(
    unique_species = n_distinct(SPECIES_CODE),
    .groups = "drop"
  )

options(tigris_use_cache = TRUE) 
state_boundaries <- states(cb = TRUE)

state_boundaries <- state_boundaries %>%
  mutate(SUBNATIONAL1_CODE = paste0("US-", STUSPS))

state_boundaries <- state_boundaries %>%
  left_join(state_species_count, by = "SUBNATIONAL1_CODE")%>% 
  filter(!is.na(unique_species))

palette <- colorNumeric(
  palette = "YlGnBu",
  domain = state_boundaries$unique_species
)


leaflet() %>%
  addTiles() %>%
  
  addCircleMarkers(
    data = unique_locations,
    ~LONGITUDE, ~LATITUDE,
    radius = 0.5,
    color = "#21918c",
    fillOpacity = 0.6,
    popup = ~paste("Lat:", LATITUDE, "Lon:", LONGITUDE),
    group = "Participant Observation Points"
  ) %>%

  addPolygons(
    data = state_boundaries,
    fillColor = ~palette(unique_species),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.7,
    highlight = highlightOptions(
      weight = 2,
      color = "#666",
      dashArray = "",
      fillOpacity = 0.9,
      bringToFront = TRUE
    ),
    label = ~paste0(NAME, ": ", unique_species, " unique species"),
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "15px",
      direction = "auto"
    ),
    group = "Species Count by State"
  ) %>%

  addLegend(
    pal = palette,
    values = state_boundaries$unique_species,
    title = "Unique Species Count",
    position = "bottomright",
    group = "Species Count by State"
  ) %>%
  addLayersControl(
    overlayGroups = c("Participant Observation Points", "Species Count by State"),
    options = layersControlOptions(collapsed = FALSE)
  )
  })
}

shinyApp(ui = leaflet_ui, server = server)
  
```

Column
------------------------------
## Timeseries

```{r timeseries}
timeseries_ui <- fillPage(
  fillCol(flex = c(NA, 1),
  inputPanel(
      selectInput("species", "Choose Bird Species:",
                  choices = sort(unique(test_df$common_name)),
                  selected = sort(unique(test_df$common_name))[1]
    )),
    mainPanel(
      plotOutput("timeseriesPlot")
    )
  )
)


server <- function(input, output, session) {
  
  filtered_data <- reactive({
    test_df %>% 
    filter(common_name == input$species)
    
  })
 
  output$timeseriesPlot <- renderPlot({
    data <- filtered_data() 
    
    if (nrow(data) > 0) {
      ggplot(data, aes(x = date, y = total)) +
        geom_line() +
        labs(title = paste("Bird Count for", input$species),
             x = "Date", 
             y = "Total Counts") +
        theme_minimal() +
        theme(legend.position = "bottom")
    } else {
      ggplot() + 
        geom_blank() + 
        labs(title = "No data available for the selected species.")
    }
  })
  
}

shinyApp(ui = timeseries_ui, server = server)

```

### Data Table
```{r dt}
datatable(test_df)

```
